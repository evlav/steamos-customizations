#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-2.0-only

set -e

PRESET_TEMPLATE=/usr/share/mkinitcpio/hook.preset

if [ ! -f "${PRESET_TEMPLATE:-/dev/null}" ]; then
    echo "ALPM: $0 - no mkinitcpio template at '${PRESET_TEMPLATE:-}'" >&2
    exit 1
fi

while read -r line; do
    read -r pkgbase < "${line%/vmlinuz}/pkgbase"
    preset="/etc/mkinitcpio.d/${pkgbase}.preset"

    # create the preset(s) from the template before mkinitcpio does
    # make sure the only preset profile triggered is 'default'
    (echo "# generated from $PRESET_TEMPLATE";
     sed -e "s|%PKGBASE%|${pkgbase}|g;" \
         -e "s/^PRESETS=.*/PRESETS=('default')/" ${PRESET_TEMPLATE};
     echo "PRESETS=('default')") \
        | install -Dm644 /dev/stdin "$preset"
done

# XXX: use conf snippets, drop this hack
conf="/etc/mkinitcpio.conf"
if [ -e $conf ]; then
    sed -i '/^HOOKS=/d' $conf
    sed -i '/^MODULES=/d' $conf
    echo "HOOKS=(base udev steamos steam-deck modconf keyboard block filesystems) # set by $0" >> $conf
    echo "MODULES=(nvme) # set by $0" >> $conf
fi
